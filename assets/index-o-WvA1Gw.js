const h="__TSR_index",O="popstate",K="beforeunload";function D(t){let e=t.getLocation();const s=new Set,l=r=>{e=t.getLocation(),s.forEach(n=>n({location:e,action:r}))},u=r=>{t.notifyOnIndexChange??!0?l(r):e=t.getLocation()},f=async({task:r,navigateOpts:n,...i})=>{if(n?.ignoreBlocker??!1){r();return}const d=t.getBlockers?.()??[],S=i.type==="PUSH"||i.type==="REPLACE";if(typeof document<"u"&&d.length&&S)for(const L of d){const b=x(i.path,i.state);if(await L.blockerFn({currentLocation:e,nextLocation:b,action:i.type})){t.onBlocked?.();return}}r()};return{get location(){return e},get length(){return t.getLength()},subscribers:s,subscribe:r=>(s.add(r),()=>{s.delete(r)}),push:(r,n,i)=>{const a=e.state[h];n=U(a+1,n),f({task:()=>{t.pushState(r,n),l({type:"PUSH"})},navigateOpts:i,type:"PUSH",path:r,state:n})},replace:(r,n,i)=>{const a=e.state[h];n=U(a,n),f({task:()=>{t.replaceState(r,n),l({type:"REPLACE"})},navigateOpts:i,type:"REPLACE",path:r,state:n})},go:(r,n)=>{f({task:()=>{t.go(r),u({type:"GO",index:r})},navigateOpts:n,type:"GO"})},back:r=>{f({task:()=>{t.back(r?.ignoreBlocker??!1),u({type:"BACK"})},navigateOpts:r,type:"BACK"})},forward:r=>{f({task:()=>{t.forward(r?.ignoreBlocker??!1),u({type:"FORWARD"})},navigateOpts:r,type:"FORWARD"})},canGoBack:()=>e.state[h]!==0,createHref:r=>t.createHref(r),block:r=>{if(!t.setBlockers)return()=>{};const n=t.getBlockers?.()??[];return t.setBlockers([...n,r]),()=>{const i=t.getBlockers?.()??[];t.setBlockers?.(i.filter(a=>a!==r))}},flush:()=>t.flush?.(),destroy:()=>t.destroy?.(),notify:l}}function U(t,e){e||(e={});const s=R();return{...e,key:s,__TSR_key:s,[h]:t}}function N(t){const e=t?.window??(typeof document<"u"?window:void 0),s=e.history.pushState,l=e.history.replaceState;let u=[];const f=()=>u,r=o=>u=o,n=t?.createHref??(o=>o),i=t?.parseLocation??(()=>x(`${e.location.pathname}${e.location.search}${e.location.hash}`,e.history.state));if(!e.history.state?.__TSR_key&&!e.history.state?.key){const o=R();e.history.replaceState({[h]:0,key:o,__TSR_key:o},"")}let a=i(),d,S=!1,L=!1,b=!1,P=!1;const F=()=>a;let k,_;const v=()=>{k&&(y._ignoreSubscribers=!0,(k.isPush?e.history.pushState:e.history.replaceState)(k.state,"",k.href),y._ignoreSubscribers=!1,k=void 0,_=void 0,d=void 0)},E=(o,c,g)=>{const p=n(c);_||(d=a),a=x(c,g),k={href:p,state:g,isPush:k?.isPush||o==="push"},_||(_=Promise.resolve().then(()=>v()))},w=o=>{a=i(),y.notify({type:o})},A=async()=>{if(L){L=!1;return}const o=i(),c=o.state[h]-a.state[h],g=c===1,p=c===-1,B=!g&&!p||S;S=!1;const G=B?"GO":p?"BACK":"FORWARD",m=B?{type:"GO",index:c}:{type:p?"BACK":"FORWARD"};if(b)b=!1;else{const C=f();if(typeof document<"u"&&C.length){for(const I of C)if(await I.blockerFn({currentLocation:a,nextLocation:o,action:G})){L=!0,e.history.go(1),y.notify(m);return}}}a=i(),y.notify(m)},H=o=>{if(P){P=!1;return}let c=!1;const g=f();if(typeof document<"u"&&g.length)for(const p of g){const B=p.enableBeforeUnload??!0;if(B===!0){c=!0;break}if(typeof B=="function"&&B()===!0){c=!0;break}}if(c)return o.preventDefault(),o.returnValue=""},y=D({getLocation:F,getLength:()=>e.history.length,pushState:(o,c)=>E("push",o,c),replaceState:(o,c)=>E("replace",o,c),back:o=>(o&&(b=!0),P=!0,e.history.back()),forward:o=>{o&&(b=!0),P=!0,e.history.forward()},go:o=>{S=!0,e.history.go(o)},createHref:o=>n(o),flush:v,destroy:()=>{e.history.pushState=s,e.history.replaceState=l,e.removeEventListener(K,H,{capture:!0}),e.removeEventListener(O,A)},onBlocked:()=>{d&&a!==d&&(a=d)},getBlockers:f,setBlockers:r,notifyOnIndexChange:!1});return e.addEventListener(K,H,{capture:!0}),e.addEventListener(O,A),e.history.pushState=function(...o){const c=s.apply(e.history,o);return y._ignoreSubscribers||w("PUSH"),c},e.history.replaceState=function(...o){const c=l.apply(e.history,o);return y._ignoreSubscribers||w("REPLACE"),c},y}function x(t,e){const s=t.indexOf("#"),l=t.indexOf("?"),u=R();return{href:t,pathname:t.substring(0,s>0?l>0?Math.min(s,l):s:l>0?l:t.length),hash:s>-1?t.substring(s):"",search:l>-1?t.slice(l,s===-1?void 0:s):"",state:e||{[h]:0,key:u,__TSR_key:u}}}function R(){return(Math.random()+1).toString(36).substring(7)}export{N as c,x as p};
